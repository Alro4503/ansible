---
- name: Modificaci√≥n completa de particiones en slurm.conf
  hosts: all
  become: yes
  vars:
    partition_name: "interactive"  # Nombre de la partici√≥n a modificar
    config_completa:  # Todos los par√°metros configurables
      Nodes: "bioinf3.vhio.org,bioinf4.vhio.org,bioinf5.vhio.org,bioinf8.vhio.org"
      MaxTime: "INFINITE"
      State: "UP"
      PriorityTier: "50"
      Default: "NO"
      AllowGroups: ""
      AllowAccounts: ""

  tasks:
    - name: Verificar archivo de configuraci√≥n
      stat:
        path: /etc/slurm/slurm.conf
      register: slurm_conf

    - name: Obtener l√≠nea actual completa
      shell: |
        grep -P "^(#?\s*PartitionName={{ partition_name }}\b)" /etc/slurm/slurm.conf || echo "no_encontrado"
      register: linea_actual
      changed_when: false
      when: slurm_conf.stat.exists

    - name: Construir nueva l√≠nea con todos los par√°metros
      set_fact:
        nueva_linea: >-
          {% set is_commented = linea_actual.stdout is match('^#') %}{% if is_commented %}# {% endif %}PartitionName={{ partition_name }}
          {% for param, value in config_completa.items() %}{% if value %}{{ param }}={{ value }} {% endif %}{% endfor %}
      when: 
        - slurm_conf.stat.exists
        - "'no_encontrado' not in linea_actual.stdout"

    - name: Reemplazar l√≠nea existente
      replace:
        path: /etc/slurm/slurm.conf
        regexp: "^{{ linea_actual.stdout | regex_escape() }}$"
        replace: "{{ nueva_linea | trim }}"
      when: 
        - slurm_conf.stat.exists
        - nueva_linea is defined
      register: cambio_realizado

    - name: Mostrar resumen detallado
      debug:
        msg: |-
          === RESULTADO EN {{ inventory_hostname }} ===
          {% if 'no_encontrado' in linea_actual.stdout %}
          ‚ùå ERROR: Partici√≥n '{{ partition_name }}' no encontrada
          {% elif cambio_realizado.changed %}
          ‚úÖ √âXITO: L√≠nea actualizada:
          {{ nueva_linea | trim }}
          ---
          Cambios realizados:
          {% for param, value in config_completa.items() %}
          - {{ param }}: {{ value }}{% endfor %}
          {% else %}
          ‚ÑπÔ∏è INFO: La configuraci√≥n ya estaba actualizada
          {% endif %}
          
          üîç Verificaci√≥n:
          grep -A5 "PartitionName={{ partition_name }}" /etc/slurm/slurm.conf
      when: slurm_conf.stat.exists
