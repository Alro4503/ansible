    # === FASE 6: FINALIZACI√ìN Y REACTIVACI√ìN (solo si se drene√≥) ===
    - name: Mostrar uso final de /tmp despu√©s de limpieza
      shell: df -h /tmp
      register: final_usage
      changed_when: false
      
    - name: Reactivar nodo (SOLO si fue dreneado) - CORREGIDO
      shell: |
        scontrol update NodeName={{ hostname_full.stdout }} State=IDLE  # ‚úÖ CORRECTO
      register: resume_result
      failed_when: false
      when: 
        - all_jobs.stdout != "" and all_jobs.stdout_lines | length > 0
        - wait_result.rc == 1 
        - remaining_jobs.stdout_lines | length > 0
      
    - name: Verificar estado final del nodo
      shell: |
        sinfo -n {{ hostname_full.stdout }} -h -o "%t"
      register: final_node_state
      changed_when: false
      when: 
        - all_jobs.stdout != "" and all_jobs.stdout_lines | length > 0
        - wait_result.rc == 1 
        - remaining_jobs.stdout_lines | length > 0
      
    - name: Limpiar archivo temporal de usuarios problem√°ticos
      file:
        path: /tmp/problematic_users.txt
        state: absent
      
    - name: Resultado final completo
      debug:
        msg: |
          {% if all_jobs.stdout == "" or all_jobs.stdout_lines | length == 0 %}
          "‚úÖ NO HAB√çA JOBS - SOLO LIMPIEZA EJECUTADA"
          "=== LIMPIEZA /TMP ==="
          "Archivos eliminados: {{ old_files_count.stdout }}"
          "Directorios eliminados: {{ old_dirs_count.stdout }}"
          "Uso inicial: {{ initial_usage.stdout_lines[-1] | default('N/A') }}"
          "Uso final: {{ final_usage.stdout_lines[-1] | default('N/A') }}"
          {% elif wait_result.rc == 0 %}
          "‚úÖ TODOS LOS JOBS COMPLETARON NORMALMENTE + LIMPIEZA EJECUTADA"
          "Jobs originales: {{ all_jobs.stdout_lines | length }}"
          "=== LIMPIEZA /TMP ==="
          "Archivos eliminados: {{ old_files_count.stdout }}"
          "Directorios eliminados: {{ old_dirs_count.stdout }}"
          {% else %}
          "üéØ PROCESO COMPLETADO EN {{ hostname_full.stdout }}"
          "=== GESTI√ìN DE JOBS ==="
          "Jobs originales: {{ all_jobs.stdout_lines | length }}"
          "Jobs pendientes despu√©s de timeout: {{ remaining_jobs.stdout_lines | length }}"
          "Usuarios problem√°ticos: {{ problematic_users.stdout_lines | length }}"
          "Nodo destino: {{ alternative_node.stdout }}"
          "=== LIMPIEZA /TMP ==="
          "Archivos eliminados: {{ old_files_count.stdout }}"
          "Directorios eliminados: {{ old_dirs_count.stdout }}"
          "Uso inicial: {{ initial_usage.stdout_lines[-1] | default('N/A') }}"
          "Uso final: {{ final_usage.stdout_lines[-1] | default('N/A') }}"
          "=== ESTADO NODO ==="
          "Nodo reactivado: {{ '‚úÖ S√ç' if final_node_state.stdout == 'idle' or final_node_state.stdout == 'mix' or final_node_state.stdout == 'alloc' else '‚ùå NO - Estado: ' + final_node_state.stdout }}"
          {% endif %}
